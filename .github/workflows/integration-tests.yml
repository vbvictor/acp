name: Integration Tests

on:
  # Run on pushes to main branch
  push:
    branches:
      - main
  # Run on pull requests
  pull_request:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:
  # Optional: Run nightly
  # schedule:
  #   - cron: '0 2 * * *'  # 2 AM UTC daily

jobs:
  integration-test:
    runs-on: ubuntu-latest

    # Only run if INTEGRATION_TEST_TOKEN secret is set
    if: ${{ secrets.INTEGRATION_TEST_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Configure Git
        run: |
          git config --global user.name "ACP Integration Test"
          git config --global user.email "test@acp-integration.test"

      - name: Run integration tests
        env:
          GITHUB_TOKEN: ${{ secrets.INTEGRATION_TEST_TOKEN }}
          # Override these if your test repos are different
          # ACP_TEST_ORG: acp-integration-test
          # ACP_TEST_REPO: test-repo
          # ACP_TEST_UPSTREAM: upstream-repo
          # ACP_TEST_FORK_OWNER: test-user
        run: |
          pytest test_integration.py -v -m integration --tb=short

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            .pytest_cache/
            test-results/
